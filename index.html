<!doctype html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>Sympathetic Synthesizer System Mk1</title>
        <meta name="description" content="An analogue synth made with the Web Audio API"/>
        <meta name="author" content="Stuart Memo"/>
        <link rel="stylesheet" media="screen, projection" href="styles/synth.css"/>
        <link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
        <link rel="shortcut icon" type="image/ico" href="images/favicon.ico" />
    </head>
    <body>
        <div class="synth">
            <h1>Sympathetic Synthesizer System Mk 1</h1>
            <div class="controls">
                <div class="module oscillators">

                    <!-- Oscillator 1 -->
                    <div class="osc1">
                        <h2>Oscillator 1</h2>
                        <div class="left-half">
                            <label for="osc1-waveform">Waveform</label>
                            <select data-oscillator="osc1" data-param="waveform" name="osc1-waveform" class="waveform">
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="square" selected>Square</option>
                            </select>
                        </div>
                        <div class="right-half">
                            <label for="osc1-range">Range</label>
                            <select data-oscillator="osc1" data-param="range" name="osc1-range" class="range">
                                <option value="32" selected>32</option>
                                <option value="16">16</option>
                                <option value="8">8</option>
                                <option value="4">4</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <label for="osc1-detune">Tuning</label>
                        <input data-oscillator="osc1" data-param="detune" type="range" min="-50" max="50" step="1" value="-6"/>
                        <label for="osc1-volume">Volume</label>
                        <input name="osc1-volume" data-oscillator="osc1" data-param="mixer" type="range" min="0" max="1" step="0.05" value="0.5"/>
                    </div>

                    <!-- Oscillator 2 -->
                    <div class="osc2">
                        <h2>Oscillator 2</h2>
                        <div class="left-half">
                            <label for="osc2-waveform">Waveform</label>
                            <select data-oscillator="osc2" data-param="waveform" name="osc2-waveform">
                                <option value="triangle" >Triangle</option>
                                <option value="sawtooth" selected>Sawtooth</option>
                                <option value="square">Square</option>
                            </select>
                        </div>
                        <div class="right-half">
                            <label for="osc2-range">Range</label>
                            <select data-oscillator="osc2" data-param="range" name="osc2-range" class="range">
                                <option value="32">32</option>
                                <option value="16" selected>16</option>
                                <option value="8">8</option>
                                <option value="4">4</option>
                                <option value="2">2</option>
                            </select>
                        </div>
                        <label for="osc2-detune">Tuning</label>
                        <input data-oscillator="osc2" data-param="detune" type="range" min="-50" max="50" step="1" value="-10"/>
                        <label for="osc2-volume">Volume</label>
                        <input name="osc2-volume" data-oscillator="osc2" data-param="mixer" type="range" min="0" max="1" step="0.1" value="0.5"/>
                    </div>

                    <!-- Oscillator 3 -->
                    <div class="osc3 last">
                        <h2>Oscillator 3</h2>
                        <div class="left-half">
                            <label for="osc3-waveform">Waveform</label>
                            <select data-oscillator="osc3" data-param="waveform" name="osc3-waveform">
                                <option value="triangle">Triangle</option>
                                <option value="sawtooth">Sawtooth</option>
                                <option value="square" selected>Square</option>
                            </select>
                        </div>
                        <div class="right-half">
                            <label for="osc3-range">Range</label>
                            <select data-oscillator="osc3" data-param="range" name="osc3-range">
                                <option value="32">32</option>
                                <option value="16">16</option>
                                <option value="8">8</option>
                                <option value="4" >4</option>
                                <option value="2" selected>2</option>
                            </select>
                        </div>

                        <label for="osc3-detune">Tuning</label>
                        <input name="osc3-detune" data-oscillator="osc3" data-param="detune" type="range" min="-50" max="50" step="1" value="10"/>
                        <label for="osc3-volume">Volume</label>
                        <input name="osc3-volume" data-oscillator="osc3" data-param="mixer" type="range" min="0" max="1" step="0.1" value="0.5"/>
                    </div>
                </div>
                <div class="module lfo">
                    <h2>LFO</h2>
                    <label for="lfo-waveform">Waveform</label>
                    <select data-param="lfo" name="lfo-waveType">
                        <option value="triangle" selected>Triangle</option>
                        <option value="sawtooth">Sawtooth</option>
                        <option value="square">Square</option>
                    </select>

                    <label for="lfo-frequency">Frequency</label>
                    <input data-param="lfo" name="lfo-frequency" type="range" min="0" max="30" step="1" value="0"/>

                    <label for="lfo-depth">Depth</label>
                    <input data-param="lfo" name="lfo-depth" type="range" min="1" max="10" step="1" value="1"/>
                </div>

                <!-- Filter -->
                <div class="module filter">
                    <h2>Filter</h2>
                    <div class="left-half">
                        <label for="filter-attack">Attack</label>
                        <input name="filter-attack" data-param="filter" type="range" min="0" max="500" value="10"/>

                        <label for="filter-decay">Decay</label>
                        <input name="filter-decay" type="range" data-param="filter" min="0" max="25" value="5"/>

                        <label for="filter-sustain">Sustain</label>
                        <input name="filter-sustain" type="range" data-param="filter" min="0" max="10" value="5"/>

                        <label for="filter-release">Release</label>
                        <input name="filter-release" type="range" data-param="filter" min="0" max="5" value="2"/>
                    </div>
                    <div class="right-half">
                        <label for="cutoffFrequency">Cutoff frequency</label>
                        <input name="cutoffFrequency" data-param="filter" type="range" min="20" max="20000" step="200" value="10000"/>

                        <label for="emphasis">Emphasis</label>
                        <input name="emphasis" data-param="filter" type="range" min="0" max="10" value="5"/>

                        <label for="contour">Contour</label>
                        <input name="contour" data-param="filter" type="range" min="0" max="10" value="5"/>
                    </div>
                </div>
                <div class="module volume-filter">
                    <h2>Volume Filter</h2>
                    <label for="attack">Attack</label>
                    <input name="attack" data-param="volume-filter" type="range" min="0" max="5" step="0.1" value="0"/>

                    <label for="decay">Decay</label>
                    <input name="decay" data-param="volume-filter" type="range" min="0" max="1" step="0.1" value="0"/>
                    
                    <label for="sustain">Sustain</label>
                    <input name="sustain" data-param="volume-filter" type="range" min="0" max="1" step="0.01" value="0.5"/>
                    
                    <label for="release">Release</label>
                    <input name="release" data-param="volume-filter" type="range" min="0" max="5" step="0.1" value="0"/>
                </div>
                <div class="module noise">
                    <h2>Noise</h2>
                    <label for="level">Level</label>
                    <input name="level" data-param="noise" type="range" min="0" max="1" step="0.1" value="0"/>
                </div>
                <div class="module output">
                    <h2>Output</h2>
                    <label for="volume">Volume</label>
                    <input name="volume" data-param="volume" type="range" min="0" max="1" step="0.01"/>
                </div>
                <div class="module config-bar">
                    MIDI 
                </div>
            </div>
            <div id="keyboard"></div>
        </div>
        <script src="scripts/socket.io.js"></script>
        <script src="app/bower_components/tsw/dist/tsw.min.js"></script>
        <script src="scripts/synth.js"></script>
        <script src="app/bower_components/qwerty-hancock/dist/qwerty-hancock.min.js"></script>
        <script>
            // Check if browser is capable
            if ((typeof webkitAudioContext === 'undefined') && (typeof AudioContext === 'undefined')) {
                document.querySelectorAll('.synth')[0].insertAdjacentHTML('afterbegin',
                    '<h1>Sorry, your browser doesn\'t support the Web Audio API. ' +
                    'Try <a href="http://google.com/chrome">Chrome</a> instead!</h1>');
            }

            /*********************
            SOCKET.IO
            ***********************/
            var socket = io('http://localhost:8081/');

            var currentNotes = [];

            socket.on('message',function(data){
                console.log('message',data);
            });

            socket.on('playnote', function(notes){
                notes.forEach(function(note,i){
                    if(!note) return;
                    if(currentNotes[i] !== note){
                        if(currentNotes[i]) stopNote(currentNotes[i]);
                        currentNotes[i] = note;
                        console.log('playnote',currentNotes);
                        playNote(note);
                    }  
                });
            });

            socket.on('stopnote', function(note){
                console.log('stopnote',note);
                stopNote(note);
            });

            socket.on('settings',function(object){
                console.log('settings',object);
                updateSettings(object);
            });

            function setSetting(osc,param,name,value){
                updateSettings({
                    osc:osc,
                    param:param,
                    name:name,
                    value:value
                });
            }

            function playNote(note){
                synth.playNote(note);
                // messageReceived({
                //     data: [144,note,true]
                // });
            }

            function stopNote(note){
                synth.stopNote(note);
                // messageReceived({
                //     data: [144,note,false]
                // });
            }

            /******************************/

            var synth = new Synth({
                    context: tsw.context(),
                    speakersOn: true
                }),
                keyboard = new QwertyHancock({
                    id: 'keyboard',
                    width: 908,
                    height: 150,
                    startKey: 'A3',
                    hoverColour: '#FFE976'
                });

            var inputs = document.getElementsByTagName('input'),
                selects = document.getElementsByTagName('select');

            // Turn NodeLists into Arrays
            inputs = Array.prototype.slice.call(inputs);
            selects = Array.prototype.slice.call(selects);

            inputs = inputs.concat(selects);

            var updateSettings = function (object) {
                var object = object || {};
                var osc = object.osc || this.getAttribute('data-oscillator'),
                    param = object.param || this.getAttribute('data-param'),
                    value = object.value || this.value,
                    name = object.name || this.name;

                switch (param) {
                    case 'range':
                        synth.oscillators[osc][param] = value;
                        break;
                    case 'waveform':
                        synth.oscillators[osc][param] = value;
                        break;
                    case 'detune':
                        synth.oscillators[osc][param] = value;
                        synth.activeOscillators.forEach(function (oscillator) {
                            oscillator.detune.value = synth.oscillators[osc][param];
                        });
                        break;
                    case 'filter':
                        switch (name) {
                            case 'filter-attack':
                                synth.filterEnvelopeSettings.attack = parseInt(value, 10);
                                break;
                            case 'filter-decay':
                                synth.filterEnvelopeSettings.decay = parseInt(value, 10);
                                break;
                            case 'filter-sustain':
                                synth.filterEnvelopeSettings.sustain = parseInt(value, 10);
                                break;
                            case 'filter-release':
                                synth.filterEnvelopeSettings.release = parseInt(value, 10);
                                break;
                            case 'cutoffFrequency':
                                synth.filterEnvelopeSettings.startLevel = parseInt(value, 10);
                                break; 
                            case 'emphasis':
                                synth.filterEnvelopeSettings.Q = parseInt(value, 10);
                                break;
                            case 'contour':
                                //synth.filter.node.Q.value = parseInt(this.filter.emphasis, 10);
                                break;
                            default:
                                break;
                        };
                        break;
                    case 'volume-filter':
                        synth.volumeEnvelopeSettings[name] = parseFloat(value, 10);
                        break;
                    case 'mixer':
                        synth.mixer[osc].node.gain(value);
                        break;
                    case 'lfo':
                        switch (name) {
                            case 'lfo-waveType':
                                synth.lfoSettings.waveType = value;
                                break;
                            case 'lfo-frequency':
                                synth.lfoSettings.frequency = value;
                                break;
                            case 'lfo-depth':
                                synth.lfoSettings.node.depth = value;
                                break;
                            default:
                                break;
                        };
                    case 'volume':
                        synth.masterVolume.gain(value);
                        break;
                    case 'noise':
                        synth.noiseLevel.gain(value);
                        break;
                    default:
                        break;
                };
            };
            
            for (var i = 0; i < inputs.length; i++) {
                inputs[i].addEventListener('change', function () {
                    updateSettings.call(this);
                });

                updateSettings.call(inputs[i]);
            }
            
            keyboard.keyDown = function (note, frequency) {
                synth.playNote(note);
                socket.emit('playnote',note);
            };

            keyboard.keyUp = function (note, frequency) {
                synth.stopNote(note);
                socket.emit('stopnote',note);
            };

            var messageReceived = function (message) {

                var note = tsw.midiNote(message.data[1]),
                    keys = document.querySelectorAll('#keyboard li');

                // Only accept note data.
                if (message.data[0] === 144) {
                    if (message.data[2]) {

                        // Change colour of key on keyboard.
                        for (var i = 0; i < keys.length; i++) {
                            if (keys[i].attributes.title.value === note) {
                                keys[i].style.backgroundColor = '#FFE976';
                            }
                        }

                        synth.playNote(note);
                    } else {
                        // Chance colour of key on keyboard.
                        for (var i = 0; i < keys.length; i++) {
                                if (keys[i].attributes.title.value === note) {
                                    if (keys[i].attributes.title.value.match('#')) {
                                        keys[i].style.backgroundColor = 'black';
                                    } else {
                                        keys[i].style.backgroundColor = 'white';
                                    }
                                }
                        }
                        synth.stopNote(tsw.midiNote(message.data[1]));
                    }
                }
            };

            tsw.getUserMidi(function (midi) {
                window.midi = midi
                var inputs = midi.inputs();

                //document.querySelector('.config-bar').style.display = 'block';

                if (inputs.length) {
                    var input = inputs[0];
                    input.addEventListener('midimessage', messageReceived);
                }
            }, function () {
                console.log('no midi support')
            });

        </script>
    </body>
</html>
